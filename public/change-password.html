<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ƒê·ªïi m·∫≠t kh·∫©u - POSM Survey System</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .change-password-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        padding: 20px;
      }

      .change-password-box {
        background: white;
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        padding: 40px;
        width: 100%;
        max-width: 450px;
        text-align: center;
      }

      .change-password-logo {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .change-password-title {
        color: #333;
        margin-bottom: 10px;
        font-size: 24px;
        font-weight: 600;
      }

      .change-password-subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .back-link {
        position: absolute;
        top: 20px;
        left: 20px;
        color: white;
        text-decoration: none;
        font-size: 16px;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
      }

      .back-link:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-3px);
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-control:focus {
        outline: none;
        border-color: #74b9ff;
        box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.1);
      }

      .form-control.error {
        border-color: #d63031;
      }

      .form-control.success {
        border-color: #00b894;
      }

      .field-error {
        color: #d63031;
        font-size: 12px;
        margin-top: 5px;
        display: none;
      }

      .field-success {
        color: #00b894;
        font-size: 12px;
        margin-top: 5px;
        display: none;
      }

      .password-strength {
        margin-top: 5px;
        font-size: 12px;
      }

      .strength-weak {
        color: #d63031;
      }
      .strength-medium {
        color: #fdcb6e;
      }
      .strength-strong {
        color: #00b894;
      }

      .btn-change-password {
        width: 100%;
        padding: 14px;
        background: linear-gradient(45deg, #74b9ff, #0984e3);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
        margin-top: 10px;
      }

      .btn-change-password:hover {
        transform: translateY(-2px);
      }

      .btn-change-password:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        background: #ffe6e6;
        color: #d63031;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #d63031;
        display: none;
      }

      .success-message {
        background: #e6f7e6;
        color: #00b894;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #00b894;
        display: none;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #74b9ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .security-notice {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #666;
        text-align: left;
      }

      .security-notice-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
      }

      @media (max-width: 480px) {
        .change-password-box {
          padding: 30px 20px;
          margin: 10px;
        }

        .change-password-title {
          font-size: 20px;
        }

        .back-link {
          position: relative;
          top: auto;
          left: auto;
          display: inline-block;
          margin-bottom: 20px;
          color: #74b9ff;
          background: white;
        }
      }
    </style>
  </head>
  <body>
    <a href="javascript:history.back()" class="back-link">‚Üê Quay l·∫°i</a>

    <div class="change-password-container">
      <div class="change-password-box">
        <div class="change-password-logo">üîê</div>
        <h1 class="change-password-title">ƒê·ªïi m·∫≠t kh·∫©u</h1>
        <p class="change-password-subtitle">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u c·ªßa b·∫°n</p>

        <div class="security-notice">
          <div class="security-notice-title">L∆∞u √Ω b·∫£o m·∫≠t:</div>
          Sau khi ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng, b·∫°n s·∫Ω ƒë∆∞·ª£c ƒëƒÉng xu·∫•t v√† c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i v·ªõi m·∫≠t kh·∫©u
          m·ªõi.
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <form id="changePasswordForm">
          <div class="form-group">
            <label for="currentPassword">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
            <input
              type="password"
              id="currentPassword"
              name="currentPassword"
              class="form-control"
              required
              autocomplete="current-password"
            />
            <div id="currentPasswordError" class="field-error"></div>
          </div>

          <div class="form-group">
            <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              class="form-control"
              required
              autocomplete="new-password"
            />
            <div id="passwordStrength" class="password-strength"></div>
            <div id="newPasswordError" class="field-error"></div>
            <div id="newPasswordSuccess" class="field-success"></div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              class="form-control"
              required
              autocomplete="new-password"
            />
            <div id="confirmPasswordError" class="field-error"></div>
            <div id="confirmPasswordSuccess" class="field-success"></div>
          </div>

          <button type="submit" id="changePasswordBtn" class="btn-change-password">
            ƒê·ªïi m·∫≠t kh·∫©u
          </button>
        </form>
      </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <script>
      class ChangePasswordApp {
        constructor() {
          this.isLoading = false;
          this.init();
        }

        init() {
          this.checkAuthentication();
          this.bindEvents();
        }

        async checkAuthentication() {
          const token = localStorage.getItem('accessToken');
          const user = localStorage.getItem('user');

          if (!token || !user) {
            this.redirectToLogin();
            return;
          }

          try {
            const response = await fetch('/api/auth/verify', {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });

            if (!response.ok) {
              this.redirectToLogin();
              return;
            }

            // Update activity timestamp for session management
            localStorage.setItem('lastActivity', Date.now().toString());
          } catch (error) {
            console.error('Auth verification failed:', error);
            this.redirectToLogin();
          }
        }

        redirectToLogin() {
          localStorage.clear();
          window.location.replace('/login.html');
        }

        bindEvents() {
          const form = document.getElementById('changePasswordForm');
          form.addEventListener('submit', (e) => this.handleChangePassword(e));

          // Real-time validation
          document
            .getElementById('newPassword')
            .addEventListener('input', (e) => this.validateNewPassword(e.target.value));
          document
            .getElementById('confirmPassword')
            .addEventListener('input', (e) => this.validatePasswordMatch());
          document
            .getElementById('currentPassword')
            .addEventListener('input', () => this.clearFieldError('currentPassword'));

          // Enter key support
          document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !this.isLoading) {
              form.dispatchEvent(new Event('submit'));
            }
          });
        }

        validateNewPassword(password) {
          const field = document.getElementById('newPassword');
          const strengthDiv = document.getElementById('passwordStrength');
          const errorDiv = document.getElementById('newPasswordError');
          const successDiv = document.getElementById('newPasswordSuccess');

          // Clear previous states
          field.classList.remove('error', 'success');
          errorDiv.style.display = 'none';
          successDiv.style.display = 'none';

          if (!password) {
            strengthDiv.textContent = '';
            return false;
          }

          // Password strength validation
          const minLength = password.length >= 6;
          const hasLower = /[a-z]/.test(password);
          const hasUpper = /[A-Z]/.test(password);
          const hasNumber = /\d/.test(password);
          const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

          let strength = 0;
          let strengthText = '';
          let strengthClass = '';

          if (minLength) strength++;
          if (hasLower) strength++;
          if (hasUpper) strength++;
          if (hasNumber) strength++;
          if (hasSpecial) strength++;

          if (!minLength) {
            strengthText = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
            strengthClass = 'strength-weak';
            field.classList.add('error');
            errorDiv.textContent = strengthText;
            errorDiv.style.display = 'block';
            strengthDiv.textContent = '';
            return false;
          } else if (strength < 3) {
            strengthText = 'M·∫≠t kh·∫©u y·∫øu - N√™n c√≥ ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë';
            strengthClass = 'strength-weak';
          } else if (strength < 4) {
            strengthText = 'M·∫≠t kh·∫©u trung b√¨nh - N√™n th√™m k√Ω t·ª± ƒë·∫∑c bi·ªát';
            strengthClass = 'strength-medium';
          } else {
            strengthText = 'M·∫≠t kh·∫©u m·∫°nh';
            strengthClass = 'strength-strong';
            field.classList.add('success');
            successDiv.textContent = 'M·∫≠t kh·∫©u h·ª£p l·ªá';
            successDiv.style.display = 'block';
          }

          strengthDiv.textContent = strengthText;
          strengthDiv.className = `password-strength ${strengthClass}`;

          // Also validate confirm password if it has value
          this.validatePasswordMatch();

          return strength >= 3;
        }

        validatePasswordMatch() {
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          const field = document.getElementById('confirmPassword');
          const errorDiv = document.getElementById('confirmPasswordError');
          const successDiv = document.getElementById('confirmPasswordSuccess');

          // Clear previous states
          field.classList.remove('error', 'success');
          errorDiv.style.display = 'none';
          successDiv.style.display = 'none';

          if (!confirmPassword) {
            return false;
          }

          if (newPassword !== confirmPassword) {
            field.classList.add('error');
            errorDiv.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
            errorDiv.style.display = 'block';
            return false;
          } else {
            field.classList.add('success');
            successDiv.textContent = 'M·∫≠t kh·∫©u kh·ªõp';
            successDiv.style.display = 'block';
            return true;
          }
        }

        clearFieldError(fieldName) {
          const field = document.getElementById(fieldName);
          const errorDiv = document.getElementById(fieldName + 'Error');

          field.classList.remove('error');
          errorDiv.style.display = 'none';
        }

        showLoading() {
          this.isLoading = true;
          document.getElementById('loadingOverlay').style.display = 'flex';
          document.getElementById('changePasswordBtn').disabled = true;
        }

        hideLoading() {
          this.isLoading = false;
          document.getElementById('loadingOverlay').style.display = 'none';
          document.getElementById('changePasswordBtn').disabled = false;
        }

        showError(message) {
          const errorDiv = document.getElementById('errorMessage');
          const successDiv = document.getElementById('successMessage');

          successDiv.style.display = 'none';
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';

          // Auto hide after 8 seconds
          setTimeout(() => {
            errorDiv.style.display = 'none';
          }, 8000);
        }

        showSuccess(message) {
          const errorDiv = document.getElementById('errorMessage');
          const successDiv = document.getElementById('successMessage');

          errorDiv.style.display = 'none';
          successDiv.textContent = message;
          successDiv.style.display = 'block';
        }

        async authenticatedFetch(url, options = {}) {
          const token = localStorage.getItem('accessToken');

          if (!token) {
            this.redirectToLogin();
            return null;
          }

          const headers = {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers,
          };

          try {
            const response = await fetch(url, {
              ...options,
              headers,
            });

            if (response.status === 401) {
              // Try to refresh token
              const refreshed = await this.refreshAuthToken();
              if (refreshed) {
                // Retry with new token
                const newToken = localStorage.getItem('accessToken');
                headers['Authorization'] = `Bearer ${newToken}`;
                return await fetch(url, { ...options, headers });
              } else {
                this.redirectToLogin();
                return null;
              }
            }

            return response;
          } catch (error) {
            console.error('Authenticated fetch failed:', error);
            throw error;
          }
        }

        async refreshAuthToken() {
          const refreshToken = localStorage.getItem('refreshToken');

          if (!refreshToken) {
            return false;
          }

          try {
            const response = await fetch('/api/auth/refresh', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ refreshToken }),
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                localStorage.setItem('accessToken', result.data.accessToken);
                if (result.data.refreshToken) {
                  localStorage.setItem('refreshToken', result.data.refreshToken);
                }
                return true;
              }
            }
            return false;
          } catch (error) {
            console.error('Token refresh failed:', error);
            return false;
          }
        }

        async handleChangePassword(e) {
          e.preventDefault();

          if (this.isLoading) return;

          const formData = new FormData(e.target);
          const currentPassword = formData.get('currentPassword').trim();
          const newPassword = formData.get('newPassword').trim();
          const confirmPassword = formData.get('confirmPassword').trim();

          // Validate form
          if (!currentPassword || !newPassword || !confirmPassword) {
            this.showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ c√°c tr∆∞·ªùng');
            return;
          }

          // Validate new password strength
          if (!this.validateNewPassword(newPassword)) {
            this.showError('M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë√°p ·ª©ng y√™u c·∫ßu b·∫£o m·∫≠t');
            return;
          }

          // Validate password match
          if (!this.validatePasswordMatch()) {
            this.showError('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
            return;
          }

          // Check if new password is different from current
          if (currentPassword === newPassword) {
            this.showError('M·∫≠t kh·∫©u m·ªõi ph·∫£i kh√°c m·∫≠t kh·∫©u hi·ªán t·∫°i');
            return;
          }

          try {
            this.showLoading();

            const response = await this.authenticatedFetch('/api/auth/change-password', {
              method: 'POST',
              body: JSON.stringify({
                currentPassword,
                newPassword,
              }),
            });

            if (!response) return; // Authentication failed, already redirected

            const result = await response.json();

            if (response.ok && result.success) {
              this.showSuccess('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! ƒêang ƒëƒÉng xu·∫•t...');

              // Clear authentication data and redirect to login
              setTimeout(() => {
                localStorage.clear();
                window.location.replace('/login.html');
              }, 2000);
            } else {
              this.showError(result.message || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i');
            }
          } catch (error) {
            console.error('Change password error:', error);
            this.showError('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.');
          } finally {
            this.hideLoading();
          }
        }
      }

      // Initialize app when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        new ChangePasswordApp();
      });
    </script>
  </body>
</html>
